virsh start --console node2

+++++++++++++++++++
nginx编译安装

nginx-1.10-3.x86_64.rpm 编译好的二进制可执行文件
nginx-1.10-3.src.rpm 源码包

nginx 01]# ls
01.txt        myconf.patch             php-7.2-2.x86_64.rpm
conf          nginx-1.10-3.src.rpm     tftpboot
dhcpd         nginx-1.10-3.x86_64.rpm  vsftpd.conf
dnsmasq.conf  php-7.2-2.src.rpm
(nginx-1.10-3.x86_64.rpm 编译好的二进制可执行文件
nginx-1.10-3.src.rpm 源码包 )

nginx 01]# rpm -ivh nginx-1.10-3.src.rpm
nginx 01]# ls /root
 rpmbuild
nginx ~]# ls rpmbuild/
SOURCES  SPECS
(SOURCES文件夹里是放源码包,SPECS是应答文件)
rpmbuild]# ls SOURCES/
conf.patch  myconf.patch  nginx-1.10.3.tar.gz  nginx.service
nginx rpmbuild]# ls SPECS/
nginx.spec


Name:		nginx
Version:	1.10  (版本号)
Release:	3     (稳定版本号)
Summary:(说明) NGINX is the fastest growing and highest performing software for modern web architectures.   

Group:		mysoft
License:	GPLv2
URL:		http://nginx.org/
Source0:	nginx-%{version}.%{release}.tar.gz
Source1:	myconf.patch
Source2:	nginx.service
Source3:	conf.patch
BuildRoot:	%(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)

%define		debug_package %{nil}
BuildRequires:(编译所需要的依赖包) glibc gcc perl pkgconfig zlib-devel lua-devel pcre-devel openssl-devel nss-devel  
Requires:(安装所需要的依赖包) nss-tools nss-util bash lua pcre openssl
Packager:	luck (作者)
%description  (描述信息)
	Nginx WWW services .

%prep  (从这里开始安装)
%setup -q -c -n nginx-1.10.3  (解包)

%build
cd nginx-%{version}.%{release} 
./configure --prefix=/usr/local/nginx \  (在这里开始configure配置)
--with-http_ssl_module --with-http_v2_module \
--with-http_realip_module --with-http_stub_status_module --with-pcre \
--without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module
make (make编译)

%install
cd nginx-%{version}.%{release}
make DESTDIR=${RPM_BUILD_ROOT} install (make install安装)
cd %{buildroot}/usr/local/nginx
cp %{SOURCE1} %{buildroot}/usr/local/nginx/conf/
patch -p1 -i %{SOURCE3}
mkdir -p %{buildroot}/{usr/lib/systemd/system,var/log/weblog}
cp %{SOURCE2} %{buildroot}/usr/lib/systemd/system/

%clean
rm -rf %{buildroot} %{_builddir}

%files  (files是作成rpm包是那此文件要打包)
%defattr(-,root,root,-)
/usr/local/nginx
/usr/lib/systemd/system/nginx.service
%defattr(-,web,web,0775)
/var/log/weblog

%pre (安装rpm包前要执行的命令)
if  ! $(id web &>/dev/null);then
    groupadd -g 1000 web
    useradd -u 1000 -g 1000 web -s /sbin/nologin
fi

%post (安装rpm包后要执行的命令)

%preun (卸载rpm包前要执行的命令,先停服务)
systemctl stop nginx

%postun (卸载rpm后前要执行的命令,清除缓存文件)
rm -rf /var/cache/nginx

%changelog

++++++++++++++++++++++
nginx rpmbuild]# ls
SOURCES  SPECS

root@nginx rpmbuild]# rpmbuild -bs SPECS/nginx.spec 
写道:/root/rpmbuild/SRPMS/nginx-1.10-3.src.rpm
(-bs是用源码和SPRMS文件创建一个rpm的源码包,在SPRMS里有个nginx-1.10-3.src.rpm)
nginx rpmbuild]# tree
├── BUILD
├── BUILDROOT
├── RPMS
├── SOURCES
│   ├── conf.patch
│   ├── myconf.patch
│   ├── nginx-1.10.3.tar.gz
│   └── nginx.service
├── SPECS
│   └── nginx.spec
└── SRPMS
    └── nginx-1.10-3.src.rpm
nginx rpmbuild]# rpmbuild -bb SPECS/nginx.spec 
错误：构建依赖失败：
	gcc 被 nginx-1.10-3.x86_64 需要
	zlib-devel 被 nginx-1.10-3.x86_64 需要
	lua-devel 被 nginx-1.10-3.x86_64 需要
	pcre-devel 被 nginx-1.10-3.x86_64 需要
	openssl-devel 被 nginx-1.10-3.x86_64 需要
	nss-devel 被 nginx-1.10-3.x86_64 需要
nginx rpmbuild]# yum -y install glibc gcc perl pkgconfig zlib-devel lua-devel pcre-devel openssl-devel nss-devel

nginx rpmbuild]# rpmbuild -bb SPECS/nginx.spec 
(之后开始编译安装)
nginx rpmbuild]# tree
├── BUILDROOT
├── RPMS
│   └── x86_64
│       └── nginx-1.10-3.x86_64.rpm  比上面tree结构多出个编译好的二进制可执行rpm包
├── SOURCES
│   ├── conf.patch
│   ├── myconf.patch
│   ├── nginx-1.10.3.tar.gz
│   └── nginx.service
├── SPECS
│   └── nginx.spec
└── SRPMS
    └── nginx-1.10-3.src.rpm
安装编译好nginx的rpm包
nginx rpmbuild]# yum -y install RPMS/x86_64/nginx-1.10-3.x86_64.rpm
nginx nginx]# systemctl status nginx
nginx nginx]# systemctl start nginx

+++++++++++++++++++++++++++++++++++++++
apache

pache ~]# yum -y install httpd
apache ~]# apachectl -t  检测语法是否错误
Syntax OK
apache ~]# vim /etc/httpd/conf/httpd.conf
#ServerName www.example.com:80
ServerName localhost 
:wq
apache ~]# apachectl -t
Syntax OK
apache ~]# systemctl start httpd
+++++++++++++++
]# rm -rf rpmbuild/
]# rpm -ivh 01/php-7.2-2.src.rpm 
nginx rpmbuild]# tree
├── SOURCES
│   ├── php-7.2.2.tar.bz2
│   ├── php-fpm.conf
│   └── www.conf
└── SPECS
    └── php.spec
nginx rpmbuild]# vim SPECS/php.spec
Name:		php
Version:	7.2
Release:	2
Summary:	PHP is a widely-used general-purpose scripting language that is especially suited for Web development and can be embedded into HTML.

Group:		luck
License:	GPLv2
URL:		http://www.php.net/
Source0:	%{name}-%{version}.%{release}.tar.bz2
Source1:	php-fpm.conf
Source2:	www.conf
BuildRoot:	%(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)

%define         debug_package %{nil}
%define 	__check_files %{nil}
BuildRequires:	glibc gcc perl pkgconfig curl-devel gd-devel libXpm-devel zlib-devel readline-devel libxml2-devel
Requires:	nss-tools nss-util bash pcre openssl libXpm gd
Packager:	luck
%description
	PHP is a widely-used general-purpose scripting language.

%prep
%setup -q -c -n %{name}-%{version}.%{release}

%build
cd %{name}-%{version}.%{release}
./configure --prefix=/usr/local/php --with-config-file-path=/etc --enable-fd-setsize=65535 --enable-fpm --disable-ipv6 --without-sqlite3 --without-pdo-sqlite --enable-sockets --enable-sysvsem --enable-sysvshm --enable-sysvmsg --enable-shmop --enable-mbstring --enable-zip --enable-bcmath --enable-ftp --enable-soap --with-mhash --with-pcre-regex --with-pcre-dir --with-readline --with-zlib --with-curl --with-openssl --with-iconv --with-gd --with-png-dir --with-jpeg-dir --with-freetype-dir --with-xpm-dir --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd
make

%install
cd %{name}-%{version}.%{release}
make INSTALL_ROOT=${RPM_BUILD_ROOT} install
mkdir -p %{buildroot}/{etc,var/log/weblog,usr/lib/systemd/system}
cp php.ini-production %{buildroot}/etc/php.ini
cp sapi/fpm/php-fpm.service %{buildroot}/usr/lib/systemd/system/
cp %{S:1} %{buildroot}/usr/local/php/etc/
cp %{S:2} %{buildroot}/usr/local/php/etc/php-fpm.d/

%clean
rm -rf %{buildroot} %{_builddir}

%files
%defattr(-,root,root,-)
/usr/local/php
/etc/php.ini
/usr/lib/systemd/system/php-fpm.service

%pre
if  ! $(id web &>/dev/null);then
    groupadd -g 1000 web
    useradd -u 1000 -g 1000 web -s /sbin/nologin
fi

%post
for _F in php php-config phpize;do
    ln -s /usr/local/php/bin/$_F /usr/local/bin
done

%preun
systemctl stop php-fpm>/dev/null
rm -f /usr/local/bin/{php,php-config,phpize} /var/log/weblog/php*log

%postun

%changelog
++++++++++++++++++++++++++++++++
nginx rpmbuild]# yum -y install glibc gcc perl pkgconfig curl-devel gd-devel libXpm-devel zlib-devel readline-devel libxml2-devel

下午121分钟




